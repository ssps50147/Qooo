<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é¹¿é¹¿ Ã— é¹¿ç²‰ï½œæ²³å…§å¡”æ¬é‹ä»»å‹™</title>

  <!-- LIFF SDKï¼ˆæ”¯æ´ï¼šåªéœ€æ”¹ä¸€è¡Œ LIFF_IDï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg1:#fff1f7;
      --bg2:#f3fbff;
      --card:#ffffffcc;
      --text:#12202c;
      --muted:#5b6b7a;
      --pink:#ff5fa2;
      --blue:#2b7fff;
      --gold:#ffb020;
      --shadow: 0 12px 34px rgba(0,0,0,.12);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif; color:var(--text); }
    body{
      background: radial-gradient(1200px 600px at 20% 0%, var(--bg1), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, var(--bg2), transparent 55%),
                  linear-gradient(180deg, #fff, #f8fbff);
      overflow:hidden;
    }

    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      gap:10px;
      max-width:1100px;
      margin:0 auto;
      min-height:0;
    }

    .topbar{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 220px; }
    .logo{
      width:44px; height:44px;
      border-radius: 14px;
      background: #fff;
      border:1px solid rgba(0,0,0,.07);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .title{ display:flex; flex-direction:column; gap:2px; min-width: 150px; }
    .title h1{ margin:0; font-size:15px; display:flex; align-items:center; gap:8px; white-space:nowrap; }
    .badge{
      font-size:12px;
      padding:2px 8px;
      border-radius: 999px;
      background: rgba(43,127,255,.12);
      color: var(--blue);
      border: 1px solid rgba(43,127,255,.25);
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 360px;
    }

    .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
    .chip{
      display:flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius: 999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip strong{ color:var(--text); font-weight:900; }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:0;
      border-radius: 999px;
      padding:10px 12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue), #6aa7ff);
      color:#fff;
      border:0;
    }
    .btn.danger{
      background: rgba(255,95,162,.10);
      border:1px solid rgba(255,95,162,.28);
      color: var(--pink);
    }
    .btn:active{ transform: translateY(1px); }

    .main{
      flex:1;
      display:flex;
      gap:10px;
      min-height:0;
      overflow:hidden;
    }
    .board{
      flex: 1 1 auto;
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px;
      position:relative;
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }
    .boardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      flex: 0 0 auto;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
      max-width: 70%;
    }
    .hint b{ color: var(--text); }
    .selectInfo{
      font-size:12px;
      color: var(--muted);
      text-align:right;
      white-space:nowrap;
      flex: 0 0 auto;
    }

    .poles{
      flex:1 1 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      align-items:stretch;
      min-height:0;
    }

    .pole{
      position:relative;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      border:1px dashed rgba(0,0,0,.12);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:10px 10px 14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pole:hover{ border-color: rgba(43,127,255,.35); }
    .poleTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between;
      pointer-events:none;
      gap:10px;
    }
    .poleLabel{
      font-size:12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
      min-width: 0;
    }
    .poleLabel .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(255,95,162,.45);
      flex: 0 0 auto;
    }
    .poleLabel span.name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      font-weight:800;
      color: var(--text);
    }
    .poleCount{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .rod{
      position:absolute;
      left:50%;
      bottom:64px;
      width:10px;
      height: calc(100% - 100px);
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(18,32,44,.22), rgba(18,32,44,.06));
      border-radius: 999px;
      pointer-events:none;
    }

    .platform{
      position:absolute;
      left:10px; right:10px; bottom:14px;
      height:16px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(18,32,44,.16), rgba(18,32,44,.06));
      pointer-events:none;
    }
    .pedestal{
      position:absolute;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      width: min(140px, 88%);
      height: 42px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,176,32,.85), rgba(180,120,0,.85));
      border: 2px solid rgba(0,0,0,.28);
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      display:grid;
      place-items:center;
      pointer-events:none;
    }
    .pedestal span{
      font-weight:1000;
      font-size:30px;
      line-height:1;
      color: rgba(0,0,0,.80);
      text-shadow: 0 2px 0 rgba(255,255,255,.35);
      letter-spacing: 1px;
    }

    .stack{
      position:relative;
      display:flex;
      flex-direction:column; /* âœ… ä¿æŒ columnï¼›é †åºç”± JS æ–¹å¼Aæ§åˆ¶ */
      gap:8px;
      padding-bottom:60px;
      min-height:0;
    }

    /* ===== disk ===== */
    .disk{
      height: 30px;
      border-radius: 999px;
      border:2px solid rgba(0,0,0,.28);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
      font-weight:1000;
      color:#fff;
      text-shadow: 0 2px 0 rgba(0,0,0,.25);
      font-variant-numeric: tabular-nums;
      will-change: transform;
    }
    .disk.small{ height:28px; }

    /* æ–‘é»åœ–å±¤ */
    .disk::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:999px;
      pointer-events:none;
      z-index:0;
      background: var(--spots, none);
      mix-blend-mode: normal; /* âœ… è§’è‰²åŒ–ï¼šåƒè²¼ç´™ç´…æ–‘ */
      opacity: var(--spotOpacity, .55);
    }
    /* é«˜å…‰ */
    .disk::after{
      content:"";
      position:absolute;
      inset:-30px -30px auto auto;
      width:90px; height:90px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 60%);
      transform: rotate(20deg);
      opacity:.7;
      pointer-events:none;
      z-index:1;
    }
    .disk > span{ position:relative; z-index:2; } /* æ•¸å­—æ°¸é åœ¨æœ€ä¸Šå±¤ */

    .disk.selected{
      outline: 3px solid rgba(43,127,255,.65);
      transform: translateY(-3px);
      box-shadow: 0 14px 26px rgba(43,127,255,.18);
    }

    /* âœ… è¢«æ‹¿èµ·æ™‚å¾®å¾®æŠ–å‹•ï¼ˆåƒé¹¿é¹¿ç·Šå¼µï¼‰ */
    @keyframes luluJitter{
      0%{ transform: translateY(-3px) rotate(0deg); }
      20%{ transform: translateY(-4px) rotate(-1.2deg); }
      40%{ transform: translateY(-3px) rotate(1.2deg); }
      60%{ transform: translateY(-4px) rotate(-0.8deg); }
      80%{ transform: translateY(-3px) rotate(0.8deg); }
      100%{ transform: translateY(-3px) rotate(0deg); }
    }
    .disk.selected{ animation: luluJitter .22s linear infinite; }

    /* âœ… é€šé—œæ™‚ï¼šæœ€åº•ç›¤(N) å…ˆé–ƒä¸€ä¸‹é‡‘å…‰ */
    @keyframes goldFlash{
      0%{ filter:none; box-shadow: 0 10px 18px rgba(0,0,0,.10); }
      40%{ filter: drop-shadow(0 0 12px rgba(255,176,32,.95)) brightness(1.18); box-shadow: 0 16px 30px rgba(255,176,32,.22); }
      100%{ filter:none; box-shadow: 0 10px 18px rgba(0,0,0,.10); }
    }
    .disk.goldFlash{ animation: goldFlash .45s ease-out 1; }

    /* âœ… å‹•ç•«æ™‚ï¼šç›®çš„åœ°å…ˆéš±è—ä¸€é¡†ï¼ˆä¿ç•™ä½ç½®ï¼‰ */
    .disk.ghost{ opacity:0 !important; }

    /* âœ… é£›è¡Œç›¤å­ï¼ˆæ¬é‹å‹•ç•«ç”¨ï¼‰ */
    .flyingDisk{
      position:fixed;
      left:0; top:0;
      z-index: 350;
      pointer-events:none;
      margin:0;
    }

    .side{
      width: 330px;
      flex: 0 0 330px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:auto;
      padding-right: 4px;
      overscroll-behavior: contain;
    }
    .card{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px;
      flex: 0 0 auto;
    }
    .card h2{
      margin:0 0 8px;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:3px 8px;
      border-radius: 999px;
      background: rgba(255,176,32,.14);
      border:1px solid rgba(255,176,32,.28);
      color: #9a5a00;
      white-space:nowrap;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      color: var(--muted);
    }
    .row:last-child{ border-bottom:0; }
    .row b{ color: var(--text); }

    .select{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    select{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:13px;
    }

    .leader{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height: 220px;
      overflow:auto;
      padding-right: 4px;
    }
    .entry{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 10px;
      border-radius: 14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-size:12px;
      color: var(--muted);
    }
    .entry .name{
      max-width: 160px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text);
      font-weight:800;
    }
    .entry .meta{
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }

    .toast{
      position: fixed;
      left:50%;
      bottom: calc(12px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(18,32,44,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 200;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:10px;
      background: rgba(18,32,44,.18);
      backdrop-filter: blur(6px);
      border-radius: var(--radius);
      z-index: 100;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 96%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      padding:12px;
      border:1px solid rgba(0,0,0,.08);
      max-height: 52vh;
      overflow:auto;
    }
    .modal h3{ margin:0 0 6px; font-size:16px; display:flex; gap:8px; align-items:center; }
    .modal p{
      margin:0 0 10px;
      color: var(--muted);
      font-size:13px;
      line-height:1.55;
      white-space:pre-line;
    }
    .modal .actions{
      display:flex;
      gap:8px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .modal .actions .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .modal .actions .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin:10px 0 10px;
    }
    .kpi .box{
      background: rgba(43,127,255,.08);
      border:1px solid rgba(43,127,255,.18);
      border-radius: 16px;
      padding:10px;
      text-align:center;
    }
    .kpi .box .v{
      font-size:16px;
      font-weight:900;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    .kpi .box .t{ font-size:12px; color: var(--muted); margin-top:2px; }

    /* âœ… é€šé—œé ­è²¼å®¹å™¨ï¼ˆæ”¾ PNGï¼‰ */
    .luluNod{
      width:86px; height:86px;
      margin: 6px auto 10px;
      display:grid;
      place-items:center;
      transform-origin: 50% 80%;
    }
    @keyframes nod{
      0%{ transform: translateY(0) rotate(0deg); }
      20%{ transform: translateY(0) rotate(-6deg); }
      45%{ transform: translateY(1px) rotate(8deg); }
      70%{ transform: translateY(0) rotate(-5deg); }
      100%{ transform: translateY(0) rotate(0deg); }
    }
    .luluNod.play{ animation: nod .65s ease-out 1; }

    @media (max-width: 900px){
      body{ overflow:auto; }
      .wrap{ height:auto; min-height:100%; }
      .main{ flex-direction:column; overflow:visible; }
      .side{
        width:100%;
        flex: 0 0 auto;
        overflow:visible;
        padding-right: 0;
      }
      .leader{ max-height: 220px; }
      .hint{ max-width: 100%; }
    }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="é¹¿é¹¿">
          <svg width="44" height="44" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" role="img">
            <rect x="0" y="0" width="64" height="64" rx="16" fill="#FFF7FB"/>
            <path d="M22 44c0-10 8-18 18-18s18 8 18 18" stroke="#1A2B3A" stroke-width="3" stroke-linecap="round"/>
            <path d="M36 18c2-6 8-8 13-5" stroke="#FFB020" stroke-width="4" stroke-linecap="round"/>
            <path d="M33 18c-2-6-8-8-13-5" stroke="#FFB020" stroke-width="4" stroke-linecap="round"/>
            <circle cx="26" cy="34" r="3" fill="#1A2B3A"/>
            <circle cx="46" cy="34" r="3" fill="#1A2B3A"/>
            <path d="M30 42c4 3 10 3 14 0" stroke="#1A2B3A" stroke-width="3" stroke-linecap="round"/>
            <path d="M29 26c0-6 6-10 11-10" stroke="#FF5FA2" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>é¹¿é¹¿æ¬é‹ä»»å‹™ <span class="badge" id="modeBadge">LIFF</span></h1>
          <div class="sub" id="userLine">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </div>

      <div class="right">
        <div class="chip">æ­¥æ•¸ <strong id="moves">0</strong></div>
        <div class="chip">æ™‚é–“ <strong id="time">00:00</strong></div>
        <div class="controls">
          <button class="btn" id="btnHow">ç©æ³•</button>
          <button class="btn" id="btnBgm">BGMï¼šé–‹</button>
          <button class="btn danger" id="btnRestart">é‡ä¾†</button>
          <button class="btn primary" id="btnClose">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="board">
        <div class="boardHeader">
          <div class="hint">
            æ“ä½œï¼š<b>é»ä¸€ä¸‹æœ€ä¸Šå±¤ç’°æ‹¿èµ· â†’ å†é»ç›®æ¨™æŸ±æ”¾ä¸‹</b>ã€‚æŠŠæ‰€æœ‰ç’°æ¬åˆ° <b>C</b> å°±é€šé—œï¼
          </div>
          <div class="selectInfo" id="selectInfo">æœªé¸å–</div>
        </div>

        <div class="poles" id="poles"></div>

        <!-- é–‹å±€ç©æ³•è¦–çª—ï¼ˆæ¯æ—¥å¿«é€Ÿé–‹å§‹ï¼‰ -->
        <div class="overlay" id="overlayStart">
          <div class="modal">
            <h3 id="startTitle">ğŸ“– ç©æ³•</h3>
            <p id="startText">é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼</p>
            <div class="actions">
              <div class="left">
                <button class="btn" id="btnStartMore">å†çœ‹ä¸€æ¬¡ç©æ³•</button>
              </div>
              <div class="right">
                <button class="btn primary" id="btnQuickStart">å¿«é€Ÿé–‹å§‹</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Win -->
        <div class="overlay" id="overlayWin">
          <div class="modal">
            <h3>ğŸ‰ ä»»å‹™å®Œæˆï¼é¹¿é¹¿é»é ­ä¸­</h3>
            <div class="luluNod" id="luluNod" aria-label="é¹¿é¹¿é»é ­"></div>
            <p id="winText">ä½ å®Œæˆäº†æ¬é‹ã€‚</p>
            <div class="kpi">
              <div class="box">
                <div class="v" id="kpiMoves">0</div>
                <div class="t">æ­¥æ•¸</div>
              </div>
              <div class="box">
                <div class="v" id="kpiTime">00:00</div>
                <div class="t">æ™‚é–“</div>
              </div>
              <div class="box">
                <div class="v" id="kpiBest">â€”</div>
                <div class="t">ä»Šæ—¥æœ€ä½³</div>
              </div>
            </div>
            <div class="actions">
              <div class="left">
                <button class="btn" id="btnShare">åˆ†äº«</button>
              </div>
              <div class="right">
                <button class="btn" id="btnAgain">å†ç©ä¸€æ¬¡</button>
                <button class="btn primary" id="btnNext">ä¸‹ä¸€é—œ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <h2>é—œå¡ <span class="pill">èæœƒç¤ºç¯„</span></h2>

          <div class="row">
            <span>ç›¤å­æ•¸</span>
            <span class="select">
              <select id="level">
                <option value="3" selected>3ï¼ˆåˆå¿ƒé¹¿é¹¿ï¼‰</option>
                <option value="4">4</option>
                <option value="5">5ï¼ˆç†Ÿç·´é¹¿é¹¿ï¼‰</option>
                <option value="6">6</option>
                <option value="7">7ï¼ˆé«˜æ‰‹é¹¿é¹¿ï¼‰</option>
              </select>
            </span>
          </div>

          <div class="row">
            <span>é–‹å±€</span>
            <span class="select">
              <select id="startMode">
                <option value="standard" selected>æ¨™æº–ï¼ˆå…¨åœ¨ Aï¼‰</option>
                <option value="demo">ç¤ºç¯„ï¼ˆA:3..Nï¼ŒB:1ï¼ŒC:2ï¼‰</option>
              </select>
              <button class="btn" id="btnNew">é–‹å§‹</button>
            </span>
          </div>

          <div class="row">
            <span>æœ€å°‘æ­¥æ•¸</span>
            <span><b id="minMoves">â€”</b></span>
          </div>
        </div>

        <div class="card">
          <h2>ä»Šæ—¥æ’è¡Œæ¦œ <span class="pill" id="todayPill">ä»Šå¤©</span></h2>
          <div class="row">
            <span>åƒ…ä¿ç•™ä»Šæ—¥ç´€éŒ„</span>
            <span><b id="todayKey">â€”</b></span>
          </div>
          <div class="leader" id="leader"></div>
        </div>

        <div class="card">
          <h2>å°æé†’</h2>
          <div class="row"><span>ç›®æ¨™</span><span><b>å…¨éƒ¨æ¬åˆ° C</b></span></div>
          <div class="row"><span>æŸ±å­</span><span><b>A / B / C</b></span></div>
          <div class="row"><span>BGM</span><span><b>ç¨‹å¼ç”Ÿæˆï¼ˆå…éŸ³æª”ï¼‰</b></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ========= 6) LIFFï¼šåªæ”¹é€™ä¸€è¡Œ ========= */
const LIFF_ID = "2008838401-Ss5SClrX";
/* ====================================== */

const LS_TUTORIAL_LAST_DATE = "rr_tutorial_last_date";
const LS_DAILY_LEADER_PREFIX = "lulu_hanoi_leader_"; // + YYYY-MM-DD
const POLE_LABELS = ["A","B","C"]; // âœ… å·²ç§»é™¤ç¨±è¬‚ï¼Œåªç•™ A/B/C

const ui = {
  modeBadge: document.getElementById("modeBadge"),
  userLine: document.getElementById("userLine"),

  moves: document.getElementById("moves"),
  time: document.getElementById("time"),
  selectInfo: document.getElementById("selectInfo"),

  level: document.getElementById("level"),
  startMode: document.getElementById("startMode"),
  minMoves: document.getElementById("minMoves"),

  poles: document.getElementById("poles"),

  overlayStart: document.getElementById("overlayStart"),
  startTitle: document.getElementById("startTitle"),
  startText: document.getElementById("startText"),
  btnQuickStart: document.getElementById("btnQuickStart"),
  btnStartMore: document.getElementById("btnStartMore"),

  overlayWin: document.getElementById("overlayWin"),
  winText: document.getElementById("winText"),
  kpiMoves: document.getElementById("kpiMoves"),
  kpiTime: document.getElementById("kpiTime"),
  kpiBest: document.getElementById("kpiBest"),

  btnHow: document.getElementById("btnHow"),
  btnBgm: document.getElementById("btnBgm"),
  btnRestart: document.getElementById("btnRestart"),
  btnClose: document.getElementById("btnClose"),
  btnNew: document.getElementById("btnNew"),
  btnShare: document.getElementById("btnShare"),
  btnNext: document.getElementById("btnNext"),
  btnAgain: document.getElementById("btnAgain"),

  toast: document.getElementById("toast"),
  leader: document.getElementById("leader"),
  todayPill: document.getElementById("todayPill"),
  todayKey: document.getElementById("todayKey"),
};

let N = parseInt(ui.level.value, 10);     // âœ… é è¨­ 3ï¼ˆåˆå¿ƒé¹¿é¹¿ï¼‰
let MODE = ui.startMode.value;            // standard | demo
let stacks = [[],[],[]];                  // top is last (size: 1 small ... N big)
let selected = null;
let moves = 0;
let timer = null;
let startAt = null;
let elapsedSec = 0;

let readyToPlay = false;
let displayName = "é¹¿ç²‰";

/* âœ… æ¬é‹å‹•ç•«æ§åˆ¶ */
let isAnimating = false;
let hiddenMove = null; // {toPole, size}

/* ===== helpers ===== */
function todayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function fmtTime(sec){
  sec = Math.max(0, sec|0);
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1100);
}
function minMovesFor(n){ return (2 ** n) - 1; }
function displayDiskNumber(size){ return size; } // âœ… æ•¸å­—è¶Šå¤§ç›¤è¶Šå¯¬ï¼ˆç›´è¦ºï¼‰

/* ===== 3) Daily tutorial gating ===== */
function getTutorialLastDate(){
  try{ return localStorage.getItem(LS_TUTORIAL_LAST_DATE) || ""; }catch{ return ""; }
}
function setTutorialLastDate(d){
  try{ localStorage.setItem(LS_TUTORIAL_LAST_DATE, d); }catch{}
}
function showStartOverlay(){
  ui.overlayWin.classList.remove("show");
  ui.overlayStart.classList.add("show");

  const today = todayStr();
  const seenToday = (getTutorialLastDate() === today);

  if(!seenToday){
    ui.startTitle.textContent = "ğŸ“– ç©æ³•";
    ui.startText.textContent = "é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼";
    ui.btnStartMore.style.display = "inline-block";
    ui.btnStartMore.textContent = "å†çœ‹ä¸€æ¬¡ç©æ³•";
  }else{
    ui.startTitle.textContent = "ğŸ¦’ ä»Šå¤©ç¹¼çºŒæ¬é‹";
    ui.startText.textContent = "æŒ‰å³ä¸‹è§’ã€Œå¿«é€Ÿé–‹å§‹ã€ç«‹åˆ»é–‹ç©ã€‚";
    ui.btnStartMore.style.display = "inline-block";
    ui.btnStartMore.textContent = "å†çœ‹ä¸€æ¬¡ç©æ³•";
  }
}
function hideStartOverlay(){ ui.overlayStart.classList.remove("show"); }

/* ===== 4) Daily leaderboard (local only) ===== */
function leaderKey(){ return LS_DAILY_LEADER_PREFIX + todayStr(); }
function loadLeaders(){
  const key = leaderKey();
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr
      .filter(x => x && typeof x === "object")
      .map(x => ({
        name: String(x.name || "é¹¿ç²‰").slice(0, 24),
        moves: Number(x.moves),
        timeSec: Number(x.timeSec),
        level: Number(x.level),
        mode: String(x.mode || "standard"),
        ts: Number(x.ts || 0),
      }))
      .filter(x => isFinite(x.moves) && isFinite(x.timeSec) && isFinite(x.level));
  }catch{ return []; }
}
function saveLeaders(arr){
  try{ localStorage.setItem(leaderKey(), JSON.stringify(arr)); }catch{}
}
function addLeaderEntry(entry){
  const arr = loadLeaders();
  arr.push(entry);
  arr.sort((a,b)=>{
    if(a.moves !== b.moves) return a.moves - b.moves;
    if(a.timeSec !== b.timeSec) return a.timeSec - b.timeSec;
    if(a.level !== b.level) return b.level - a.level;
    return (a.ts||0) - (b.ts||0);
  });
  saveLeaders(arr.slice(0,10));
  renderLeaders();
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function renderLeaders(){
  const list = loadLeaders();
  ui.leader.innerHTML = "";
  ui.todayKey.textContent = todayStr();

  if(list.length === 0){
    const e = document.createElement("div");
    e.className = "entry";
    e.innerHTML = `<span class="name">ä»Šå¤©é‚„æ²’äººé€šé—œ</span><span class="meta">å…ˆç•¶ç¬¬ä¸€åï¼</span>`;
    ui.leader.appendChild(e);
    ui.kpiBest.textContent = "â€”";
    return;
  }

  list.forEach((x, idx)=>{
    const e = document.createElement("div");
    e.className = "entry";
    const rank = idx===0 ? "ğŸ¥‡" : idx===1 ? "ğŸ¥ˆ" : idx===2 ? "ğŸ¥‰" : `#${idx+1}`;
    const modeTag = (x.mode === "demo") ? "ç¤ºç¯„" : "æ¨™æº–";
    e.innerHTML = `
      <span class="name">${rank} ${escapeHtml(x.name)}</span>
      <span class="meta">${x.moves}æ­¥ Â· ${fmtTime(x.timeSec)} Â· ${x.level}ç›¤ Â· ${modeTag}</span>
    `;
    ui.leader.appendChild(e);
  });

  const best = list[0];
  ui.kpiBest.textContent = `${best.moves} / ${fmtTime(best.timeSec)}`;
}

/* ===== âœ… Daily spotsï¼ˆåŒä¸€å¤©åŒNå›ºå®šï¼›é¿é–‹æ•¸å­—ï¼›æœ€å¤§ç›¤æ›´å¼·ï¼‰ ===== */
const LS_DAILY_SPOTS_PREFIX  = "lulu_hanoi_spots_";  // + YYYY-MM-DD + "_" + N
let dailySpotsCache = null;

function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function hashStrToSeed(s){
  let h = 2166136261 >>> 0;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

/* ===== âœ… ä¸‰ç“£å½¢ç´…æ–‘ï¼ˆè§’è‰²åŒ–ï¼‰ ===== */
const LULU_SPOT_TEMPLATES = [
  [[28,62,16,12,-12,1.0],[72,60,15,12,10,1.0],[40,34,9,7,-8,0.7],[60,36,9,7,8,0.7]],
  [[30,58,18,13,-18,1.0],[70,56,12,9,12,0.9],[78,68,9,7,20,0.7],[62,36,8,6,0,0.6]],
  [[34,60,13,10,-10,0.9],[46,56,12,9,15,0.9],[40,70,12,9,0,0.9],[72,42,10,7,20,0.6]],
  [[28,58,16,12,-10,1.0],[72,58,16,12,10,1.0],[50,74,10,7,0,0.75],[50,40,9,6,0,0.55]],
  [[70,58,18,13,14,1.0],[32,56,12,9,-12,0.85],[24,66,10,7,-20,0.7],[44,36,8,6,8,0.55]],
];

function generateSpotsForSize(day, size, N){
  const seed = hashStrToSeed(`${day}|N:${N}|size:${size}|luluSpotsCHAR3PETAL`);
  const rnd = mulberry32(seed);

  const t = (size - 1) / (Math.max(1, N - 1));
  const isMax = (size === N);
  const scale = 0.75 + t * 0.95 + (isMax ? 0.25 : 0);

  const avoidRx = 18 + t * 2.5;
  const avoidRy = 18 + t * 3.5;

  const templateIndex = seed % LULU_SPOT_TEMPLATES.length;
  let blobs = LULU_SPOT_TEMPLATES[templateIndex];

  if(isMax){
    blobs = blobs.concat([[22,66,16,12,-10,1.1],[78,64,16,12,10,1.1]]);
  }else if(t > 0.55 && rnd() < 0.6){
    blobs = blobs.concat([[50 + (rnd()*10-5), 62 + (rnd()*10-5), 9, 7, (rnd()*20-10), 0.6]]);
  }

  const colorA = `rgba(190,45,55,1)`;
  const colorB = `rgba(150,28,40,1)`;
  const edge   = `rgba(60,10,16,0.42)`;

  const layers = [];

  for(const b of blobs){
    let [x,y,rx,ry,rot,w] = b;

    x = x + (rnd()*4-2);
    y = y + (rnd()*4-2);

    const dx0 = x - 50, dy0 = y - 50;
    const inAvoid = (dx0*dx0)/(avoidRx*avoidRx) + (dy0*dy0)/(avoidRy*avoidRy) < 1;
    if(inAvoid){
      x += (dx0 >= 0 ? 1 : -1) * (avoidRx * 0.55);
      y += (dy0 >= 0 ? 1 : -1) * (avoidRy * 0.55);
      x = Math.max(8, Math.min(92, x));
      y = Math.max(14, Math.min(86, y));
    }

    const RX = Math.round(rx * scale);
    const RY = Math.round(ry * scale);
    const c  = (rnd() < 0.55) ? colorA : colorB;

    const ang = (rot + (rnd()*10-5)) * Math.PI / 180;
    const spread = 0.42 + rnd()*0.10;
    const dx = Math.cos(ang) * RX * spread;
    const dy = Math.sin(ang) * RY * spread;

    const r1x = Math.max(6, Math.round(RX * (0.72 + rnd()*0.06)));
    const r1y = Math.max(5, Math.round(RY * (0.72 + rnd()*0.06)));
    const r2x = Math.max(6, Math.round(RX * (0.66 + rnd()*0.06)));
    const r2y = Math.max(5, Math.round(RY * (0.66 + rnd()*0.06)));

    const p1 = [x - dx*0.85, y - dy*0.85];
    const p2 = [x + dx*0.85, y + dy*0.85];
    const p3 = [x + (rnd()*2-1), y + (RY*0.55) + (rnd()*3-1.5)];

    layers.push(
      `radial-gradient(${r1x}px ${r1y}px at ${p1[0].toFixed(1)}% ${p1[1].toFixed(1)}%, ${c} 0 72%, ${edge} 73% 82%, transparent 83% 100%),
       radial-gradient(${r1x}px ${r1y}px at ${p2[0].toFixed(1)}% ${p2[1].toFixed(1)}%, ${c} 0 72%, ${edge} 73% 82%, transparent 83% 100%),
       radial-gradient(${r2x}px ${r2y}px at ${p3[0].toFixed(1)}% ${p3[1].toFixed(1)}%, ${c} 0 72%, ${edge} 73% 82%, transparent 83% 100%),
       radial-gradient(${Math.round(RX*0.55)}px ${Math.round(RY*0.45)}px at ${x.toFixed(1)}% ${(y+1).toFixed(1)}%, rgba(0,0,0,0.10) 0 60%, transparent 61% 100%)`
    );
  }

  return layers.join(", ");
}

function spotsKeyFor(N){
  return LS_DAILY_SPOTS_PREFIX + todayStr() + "_" + String(N);
}
function loadOrCreateDailySpots(N){
  const day = todayStr();
  const key = spotsKeyFor(N);

  if(dailySpotsCache && dailySpotsCache.day === day && dailySpotsCache.N === N){
    return dailySpotsCache.map;
  }

  try{
    const raw = localStorage.getItem(key);
    if(raw){
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object"){
        dailySpotsCache = { day, N, map: obj };
        return obj;
      }
    }
  }catch{}

  const map = {};
  for(let size=1; size<=N; size++){
    map[String(size)] = generateSpotsForSize(day, size, N);
  }
  try{ localStorage.setItem(key, JSON.stringify(map)); }catch{}
  dailySpotsCache = { day, N, map };
  return map;
}
function getDailySpots(size){
  const map = loadOrCreateDailySpots(N);
  return map[String(size)] || "";
}

/* ===== âœ… Win é¹¿é¹¿é ­ï¼šæ”¹ç”¨ä½ æä¾›çš„ 4 å¼µ PNGï¼ˆassets/ï¼‰ ===== */
const LULU_HEAD_PNGS = [
  "./assets/win-head-1.png",
  "./assets/win-head-2.png",
  "./assets/win-head-3.png",
  "./assets/win-head-4.png",
];
function setRandomWinHead(){
  const el = document.getElementById("luluNod");
  if(!el) return;
  const i = Math.floor(Math.random() * LULU_HEAD_PNGS.length);
  const src = LULU_HEAD_PNGS[i];
  el.innerHTML = `
    <img
      src="${src}"
      alt="é€šé—œé¹¿é¹¿é ­è²¼"
      style="width:86px;height:86px;object-fit:contain;display:block;"
    />
  `;
}

/* ===== Game ===== */
function startTimer(){
  stopTimer();
  startAt = Date.now() - elapsedSec*1000;
  timer = setInterval(()=>{
    elapsedSec = Math.floor((Date.now() - startAt)/1000);
    ui.time.textContent = fmtTime(elapsedSec);
  }, 250);
}
function stopTimer(){
  if(timer){ clearInterval(timer); timer=null; }
}

function topDisk(poleIndex){
  const arr = stacks[poleIndex];
  return arr.length ? arr[arr.length-1] : null;
}
function canPlace(size, poleIndex){
  const top = topDisk(poleIndex);
  if(top === null) return true;
  return size < top;
}

/* âœ… é‡‘å…‰é–ƒä¸€ä¸‹ç‹€æ…‹ */
let winFlashActive = false;

/* reset */
function resetGame(n, mode){
  N = n;
  MODE = mode;

  loadOrCreateDailySpots(N);  // âœ… ä»Šæ—¥åŒNå›ºå®šæ–‘é»

  stacks = [[],[],[]];
  selected = null;
  moves = 0;
  elapsedSec = 0;

  ui.moves.textContent = "0";
  ui.time.textContent = "00:00";
  ui.selectInfo.textContent = "æœªé¸å–";
  ui.overlayWin.classList.remove("show");

  ui.minMoves.textContent = String(minMovesFor(N));

  if(MODE === "demo"){
    for(let s=N; s>=3; s--) stacks[0].push(s);
    if(N>=1) stacks[1].push(1);
    if(N>=2) stacks[2].push(2);
  }else{
    for(let s=N; s>=1; s--) stacks[0].push(s);
  }

  winFlashActive = false;
  hiddenMove = null;
  isAnimating = false;

  render();
  renderLeaders();

  readyToPlay = false;
  stopTimer();
  showStartOverlay();
}

function diskWidthPercent(size){
  const min = 36, max = 94;
  const t = (size-1)/(N-1 || 1);
  return min + (max-min)*t;
}
function diskColor(size){
  const t = (size-1)/(N-1 || 1);
  const h = 48 - t*18;
  const s = 92;
  const l1 = 54 - t*6;
  const l2 = 44 - t*8;
  return `linear-gradient(180deg, hsl(${h} ${s}% ${l1}%), hsl(${h} ${s}% ${l2}%))`;
}

/* âœ… å– DOMï¼šæŸæŸ±ä¸Šæ–¹ç›¤ï¼ˆå¯¦éš› top ç›¤ï¼‰ */
function getTopDiskEl(poleIndex){
  const poleEl = ui.poles.querySelector(`.pole[data-index="${poleIndex}"]`);
  if(!poleEl) return null;
  const size = topDisk(poleIndex);
  if(size === null) return null;
  return poleEl.querySelector(`.disk[data-size="${size}"]`);
}

/* âœ… æ¬é‹å‹•ç•«ï¼šä¸Šæµ®â†’å¹³ç§»â†’è½ä¸‹ */
async function animateMove(fromPole, toPole, size){
  const fromEl = getTopDiskEl(fromPole);
  if(!fromEl) return;

  const fromRect = fromEl.getBoundingClientRect();

  // å…ˆæ›´æ–°è³‡æ–™ï¼Œå† render ä¸€æ¬¡å–å¾—ç›®çš„åœ°ä½ç½®
  stacks[fromPole].pop();
  stacks[toPole].push(size);

  hiddenMove = { toPole, size }; // ç›®çš„åœ°å…ˆéš±è—ä¸€é¡†ï¼Œç­‰å‹•ç•«çµæŸå†é¡¯ç¤º
  render();

  const toPoleEl = ui.poles.querySelector(`.pole[data-index="${toPole}"]`);
  const toEl = toPoleEl ? toPoleEl.querySelector(`.disk[data-size="${size}"]`) : null;
  if(!toEl){
    hiddenMove = null;
    render();
    return;
  }
  const toRect = toEl.getBoundingClientRect();

  // å»ºç«‹é£›è¡Œç›¤å­ï¼ˆè¤‡è£½è¦–è¦ºï¼‰
  const fly = document.createElement("div");
  fly.className = "disk flyingDisk" + (size<=2 ? " small" : "");
  fly.dataset.size = String(size);
  fly.style.width = fromRect.width + "px";
  fly.style.height = fromRect.height + "px";
  fly.style.left = fromRect.left + "px";
  fly.style.top = fromRect.top + "px";
  fly.style.background = diskColor(size);

  const spots = getDailySpots(size);
  if(spots) fly.style.setProperty("--spots", spots);

  const tt = (size-1)/(Math.max(1, N-1));
  const isMax = (size === N);
  const op = Math.min(0.92, 0.62 + tt*0.18 + (isMax ? 0.10 : 0));
  fly.style.setProperty("--spotOpacity", op.toFixed(3));

  const num = document.createElement("span");
  num.textContent = String(displayDiskNumber(size));
  fly.appendChild(num);
  document.body.appendChild(fly);

  const dx = (toRect.left - fromRect.left);
  const dy = (toRect.top - fromRect.top);

  const lift = Math.min(90, Math.max(48, Math.abs(dx)*0.14 + 52));

  await fly.animate(
    [
      { transform: `translate(0px, 0px)` },
      { transform: `translate(0px, ${-lift}px)` },
      { transform: `translate(${dx}px, ${-lift}px)` },
      { transform: `translate(${dx}px, ${dy}px)` },
    ],
    {
      duration: 440,
      easing: "cubic-bezier(.2,.9,.2,1)",
      fill: "forwards"
    }
  ).finished.catch(()=>{});

  fly.remove();
  hiddenMove = null;
  render();
}

/* render */
function render(){
  ui.poles.innerHTML = "";

  for(let i=0;i<3;i++){
    const pole = document.createElement("div");
    pole.className = "pole";
    pole.dataset.index = String(i);

    const poleTop = document.createElement("div");
    poleTop.className = "poleTop";
    poleTop.innerHTML = `
      <div class="poleLabel">
        <span class="dot"></span>
        <span class="name">${POLE_LABELS[i]}</span>
      </div>
      <div class="poleCount">${stacks[i].length} æš</div>
    `;

    const rod = document.createElement("div"); rod.className = "rod";
    const platform = document.createElement("div"); platform.className = "platform";
    const pedestal = document.createElement("div"); pedestal.className = "pedestal";
    pedestal.innerHTML = `<span>${POLE_LABELS[i]}</span>`;

    const stack = document.createElement("div"); stack.className = "stack";

    /* âœ… æ–¹å¼ Aï¼šé¡¯ç¤ºæ™‚åè½‰ â†’ è¦–è¦ºç”±ä¸Šåˆ°ä¸‹ï¼š1â†’N */
    for(const size of stacks[i].slice().reverse()){
      const d = document.createElement("div");
      d.className = "disk" + (size<=2 ? " small": "");
      d.dataset.size = String(size);

      d.style.width = diskWidthPercent(size) + "%";
      d.style.background = diskColor(size);

      const spots = getDailySpots(size);
      if(spots) d.style.setProperty("--spots", spots);
      else d.style.removeProperty("--spots");

      const t = (size-1)/(Math.max(1, N-1));
      const isMax = (size === N);
      const op = Math.min(0.92, 0.62 + t*0.18 + (isMax ? 0.10 : 0));
      d.style.setProperty("--spotOpacity", op.toFixed(3));

      const num = document.createElement("span");
      num.textContent = String(displayDiskNumber(size));
      d.appendChild(num);

      const isTop = (size === stacks[i][stacks[i].length-1]); // top is last (logic)
      const isSelected = selected && selected.fromPole === i && selected.size === size && isTop;
      if(isSelected) d.classList.add("selected");

      if(winFlashActive && i===2 && size===N) d.classList.add("goldFlash");

      // âœ… ç›®çš„åœ°éš±è—ï¼ˆå‹•ç•«ç”¨ï¼‰
      if(hiddenMove && hiddenMove.toPole===i && hiddenMove.size===size && isTop){
        d.classList.add("ghost");
      }

      d.addEventListener("click",(e)=>{ e.stopPropagation(); onPoleTap(i); });
      stack.appendChild(d);
    }

    pole.appendChild(poleTop);
    pole.appendChild(rod);
    pole.appendChild(platform);
    pole.appendChild(pedestal);
    pole.appendChild(stack);

    pole.addEventListener("click", ()=> onPoleTap(i));
    ui.poles.appendChild(pole);
  }
}

async function onPoleTap(poleIndex){
  if(ui.overlayStart.classList.contains("show")) return;
  if(!readyToPlay) return;
  if(isAnimating) return; // âœ… å‹•ç•«æœŸé–“é–æ“ä½œ

  if(!selected){
    const size = topDisk(poleIndex);
    if(size === null){ toast("é€™æ ¹æŸ±å­ç©ºç©ºçš„ï½"); sfxPop("bad"); return; }
    selected = { fromPole: poleIndex, size };
    ui.selectInfo.textContent = `å·²æ‹¿èµ·ï¼š${displayDiskNumber(size)}ï¼ˆ${POLE_LABELS[poleIndex]}ï¼‰`;
    sfxPop("pick");
    render();
    return;
  }

  const { fromPole, size } = selected;
  if(poleIndex === fromPole){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  if(!canPlace(size, poleIndex)){
    toast("æ”¾ä¸ä¸‹ï¼šå…ˆæŠŠå°çš„æ”¾ä¸Šé¢ï½");
    sfxPop("bad");
    return;
  }

  const actual = stacks[fromPole][stacks[fromPole].length-1];
  if(actual !== size){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  // âœ… æ¬é‹å‹•ç•«ï¼šä¸Šæµ®â†’å¹³ç§»â†’è½ä¸‹ï¼ˆå®Œæˆå¾Œå†è¨ˆæ­¥ã€åˆ¤æ–·é€šé—œï¼‰
  selected = null;
  ui.selectInfo.textContent = "æœªé¸å–";
  isAnimating = true;

  await animateMove(fromPole, poleIndex, size);

  moves += 1;
  ui.moves.textContent = String(moves);
  sfxPop("drop");

  isAnimating = false;

  await checkWin();
}

async function checkWin(){
  if(stacks[2].length !== N) return;

  stopTimer();

  winFlashActive = true;
  render();
  await new Promise(r=>setTimeout(r, 260));
  winFlashActive = false;
  render();

  ui.overlayWin.classList.add("show");

  setRandomWinHead();
  const nod = document.getElementById("luluNod");
  if(nod){
    nod.classList.remove("play");
    void nod.offsetWidth;
    nod.classList.add("play");
  }

  const theoretical = minMovesFor(N);
  const rank = moves === theoretical ? "å®Œç¾é¹¿ç²‰ï¼" : (moves <= theoretical + 8 ? "ç¥ç´šé¹¿ç²‰ï¼" : "åˆæ ¼é¹¿ç²‰ï¼");
  ui.winText.textContent =
    `ä½ ç”¨ ${moves} æ­¥ã€${fmtTime(elapsedSec)} å®Œæˆã€Œ${N} ç›¤æ¬é‹ã€âœ¨\n${rank}ï¼ˆæœ€å°‘ï¼š${theoretical} æ­¥ï¼‰`;

  ui.kpiMoves.textContent = String(moves);
  ui.kpiTime.textContent = fmtTime(elapsedSec);

  addLeaderEntry({
    name: displayName || "é¹¿ç²‰",
    moves,
    timeSec: elapsedSec,
    level: N,
    mode: MODE,
    ts: Date.now()
  });

  renderLeaders();
}

/* ===== 5) Procedural chill BGM (no external audio) + é»æ“Šå›é¥‹éŸ³ ===== */
let bgmOn = true;
let audio = {
  ctx: null,
  master: null,
  musicGain: null,
  noiseGain: null,
  lp: null,
  started: false,
  nextNoteT: 0,
  timer: null,
  seed: 0,
};
function ensureAudio(){
  if(audio.ctx) return;
  audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
  audio.master = audio.ctx.createGain();
  audio.master.gain.value = 0.55;
  audio.master.connect(audio.ctx.destination);

  audio.lp = audio.ctx.createBiquadFilter();
  audio.lp.type = "lowpass";
  audio.lp.frequency.value = 1600;
  audio.lp.Q.value = 0.6;

  audio.musicGain = audio.ctx.createGain();
  audio.musicGain.gain.value = 0.85;

  audio.noiseGain = audio.ctx.createGain();
  audio.noiseGain.gain.value = 0.18;

  audio.musicGain.connect(audio.lp);
  audio.noiseGain.connect(audio.lp);
  audio.lp.connect(audio.master);
}
function setBgmButton(){ ui.btnBgm.textContent = `BGMï¼š${bgmOn ? "é–‹" : "é—œ"}`; }
function startBgmIfNeeded(){
  if(!bgmOn) return;
  ensureAudio();
  if(audio.ctx.state === "suspended") audio.ctx.resume().catch(()=>{});
  if(audio.started) return;
  audio.started = true;
  audio.seed = (Date.now() % 9973) | 0;
  audio.nextNoteT = audio.ctx.currentTime + 0.06;
  audio.timer = setInterval(scheduler, 100);
}
function stopBgm(){
  if(audio.timer){ clearInterval(audio.timer); audio.timer=null; }
  audio.started = false;
}
function scheduler(){
  if(!audio.ctx) return;
  const lookAhead = 0.35;
  while(audio.nextNoteT < audio.ctx.currentTime + lookAhead){
    scheduleStep(audio.nextNoteT);
    audio.nextNoteT += stepDur();
  }
}
function bpm(){ return 78; }
function stepDur(){ return 60 / bpm(); }
function rand(){
  audio.seed = (audio.seed * 1103515245 + 12345) & 0x7fffffff;
  return (audio.seed / 0x7fffffff);
}
function noteFreq(midi){ return 440 * Math.pow(2, (midi - 69) / 12); }
const CHORDS = [
  [60, 64, 67, 71],
  [57, 60, 64, 67],
  [62, 65, 69, 72],
  [55, 59, 62, 65],
];
let stepCount = 0;

function scheduleStep(t){
  const ctx = audio.ctx;
  const bar = Math.floor(stepCount / 4) % CHORDS.length;
  const chord = CHORDS[bar];

  if(stepCount % 2 === 0){
    chord.forEach((m, i)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "triangle";
      o.detune.setValueAtTime((i - 1.5) * 3, t);
      o.frequency.setValueAtTime(noteFreq(m - 12), t);

      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.05, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.75);

      o.connect(g);
      g.connect(audio.musicGain);
      o.start(t);
      o.stop(t + 0.80);
    });
  }

  if(stepCount % 4 === 0){
    const root = chord[0] - 24;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();
    o.type = "sine";
    o.frequency.setValueAtTime(noteFreq(root), t);
    f.type = "lowpass";
    f.frequency.setValueAtTime(180, t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.085, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.35);

    o.connect(f); f.connect(g); g.connect(audio.musicGain);
    o.start(t); o.stop(t + 0.36);
  }

  if(stepCount % 2 === 1){
    noiseTick(t, 0.045, 2800 + rand()*700, 0.05);
  }
  if(stepCount % 4 === 0){ kick(t); }

  if(stepCount % 4 === 2 && rand() < 0.55){
    const pick = chord[Math.floor(rand()*chord.length)] + (rand()<0.25 ? 12 : 0);
    pluck(t + 0.03, noteFreq(pick), 0.06);
  }

  stepCount++;
}
function noiseBuffer(){
  const ctx = audio.ctx;
  const len = ctx.sampleRate * 0.2;
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<len;i++){
    data[i] = (Math.random()*2-1) * (0.9 - i/len);
  }
  return buf;
}
function noiseTick(t, dur, cutoff, amp){
  const ctx = audio.ctx;
  const src = ctx.createBufferSource();
  src.buffer = noiseBuffer();
  const f = ctx.createBiquadFilter();
  f.type = "highpass";
  f.frequency.setValueAtTime(cutoff, t);

  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(amp, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

  src.connect(f); f.connect(g); g.connect(audio.noiseGain);
  src.start(t);
  src.stop(t + dur + 0.02);
}
function kick(t){
  const ctx = audio.ctx;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";
  o.frequency.setValueAtTime(130, t);
  o.frequency.exponentialRampToValueAtTime(50, t + 0.09);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.14, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.13);

  o.connect(g); g.connect(audio.musicGain);
  o.start(t);
  o.stop(t + 0.14);
}
function pluck(t, freq, amp){
  const ctx = audio.ctx;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  const f = ctx.createBiquadFilter();
  o.type = "sine";
  o.frequency.setValueAtTime(freq, t);
  f.type = "lowpass";
  f.frequency.setValueAtTime(1200, t);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(amp, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.22);

  o.connect(f); f.connect(g); g.connect(audio.musicGain);
  o.start(t);
  o.stop(t + 0.23);
}

function sfxPop(kind){
  if(!bgmOn) return;
  ensureAudio();
  const ctx = audio.ctx;
  const t = ctx.currentTime;

  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";

  const base = kind==="pick" ? 520 : (kind==="drop" ? 430 : 320);
  const combo = Math.min(8, moves % 9);
  const f = base + combo*18;

  o.frequency.setValueAtTime(f, t);
  o.frequency.exponentialRampToValueAtTime(f * 0.92, t + 0.08);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(kind==="bad" ? 0.04 : 0.055, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.10);

  o.connect(g); g.connect(audio.master);
  o.start(t); o.stop(t + 0.11);
}

/* ===== 6) LIFF init ===== */
async function initLIFF(){
  const inLineUA = /Line/i.test(navigator.userAgent);
  try{
    if(window.liff && LIFF_ID){
      await liff.init({ liffId: LIFF_ID });
      ui.modeBadge.textContent = liff.isInClient() ? "LINE" : "WEB";
      if(liff.isLoggedIn()){
        const p = await liff.getProfile();
        displayName = p.displayName || "é¹¿ç²‰";
        ui.userLine.textContent = `Hi ${displayName}ï½œé¹¿ç²‰è«‹å°±ä½ ğŸ¦’âœ¨`;
      }else{
        displayName = "é¹¿ç²‰";
        ui.userLine.textContent = "æœªç™»å…¥ï¼ˆä»å¯ç›´æ¥ç©ï¼‰";
      }
      return;
    }
  }catch{}
  ui.modeBadge.textContent = inLineUA ? "LINE" : "WEB";
  displayName = "é¹¿ç²‰";
  ui.userLine.textContent = inLineUA ? "åœ¨ LINE å…§é–‹å•Ÿ âœ…" : "ä¸€èˆ¬ç€è¦½å™¨æ¨¡å¼";
}

function closeWindow(){
  if(window.liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
  else toast("é LINE å…§ï¼Œç„¡æ³•è‡ªå‹•é—œé–‰");
}
async function shareResult(){
  const modeTag = (MODE === "demo") ? "ç¤ºç¯„" : "æ¨™æº–";
  const text = `ğŸ¦’âœ¨ ${displayName} å®Œæˆã€Œé¹¿é¹¿æ¬é‹ä»»å‹™ã€ï¼š${N}ç›¤ï¼${moves}æ­¥ï¼${fmtTime(elapsedSec)}ï¼ˆ${modeTag}ï¼‰ï¼`;
  try{
    if(window.liff && liff.isApiAvailable && liff.isApiAvailable("shareTargetPicker")){
      await liff.shareTargetPicker([{ type:"text", text }]);
      toast("å·²å‘¼å«åˆ†äº«");
    }else{
      await navigator.clipboard.writeText(text);
      toast("å·²è¤‡è£½åˆ†äº«æ–‡å­—");
    }
  }catch{
    try{ prompt("è¤‡è£½åˆ†äº«æ–‡å­—ï¼š", text); }catch{}
  }
}
function showHowModal(){
  ui.startTitle.textContent = "ğŸ“– ç©æ³•";
  ui.startText.textContent = "é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼";
  ui.btnStartMore.style.display = "none";
  ui.overlayStart.classList.add("show");
}

/* ===== events ===== */
ui.btnHow.addEventListener("click", ()=> showHowModal());
ui.btnBgm.addEventListener("click", ()=>{
  bgmOn = !bgmOn;
  setBgmButton();
  if(!bgmOn) stopBgm();
  else startBgmIfNeeded();
});
ui.btnRestart.addEventListener("click", ()=>{
  const n = parseInt(ui.level.value, 10);
  resetGame(n, MODE);
});
ui.btnClose.addEventListener("click", closeWindow);

ui.btnNew.addEventListener("click", ()=>{
  const n = parseInt(ui.level.value,10);
  const mode = ui.startMode.value;
  resetGame(n, mode);
});

ui.btnQuickStart.addEventListener("click", ()=>{
  setTutorialLastDate(todayStr());
  hideStartOverlay();
  readyToPlay = true;
  startTimer();
  startBgmIfNeeded();
  toast("é¹¿ç²‰é›†åˆï¼é–‹æ¬ï½");
});
ui.btnStartMore.addEventListener("click", ()=>{
  ui.startTitle.textContent = "ğŸ“– ç©æ³•";
  ui.startText.textContent = "é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼";
  ui.btnStartMore.style.display = "inline-block";
});

ui.btnShare.addEventListener("click", shareResult);
ui.btnAgain.addEventListener("click", ()=>{
  ui.overlayWin.classList.remove("show");
  const n = parseInt(ui.level.value, 10);
  resetGame(n, MODE);
});
ui.btnNext.addEventListener("click", ()=>{
  ui.overlayWin.classList.remove("show");
  const current = parseInt(ui.level.value, 10);
  const next = Math.min(7, current + 1);
  ui.level.value = String(next);
  resetGame(next, MODE);
});

/* ===== boot ===== */
(function purgeOldLeaderboards(){
  const today = LS_DAILY_LEADER_PREFIX + todayStr();
  try{
    const del = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith(LS_DAILY_LEADER_PREFIX) && k !== today) del.push(k);
    }
    del.forEach(k=> localStorage.removeItem(k));
  }catch{}
})();

(async function main(){
  setBgmButton();
  await initLIFF();

  ui.todayPill.textContent = "ä»Šå¤©";
  ui.todayKey.textContent = todayStr();

  renderLeaders();

  ui.level.value = "3";
  N = 3;
  MODE = ui.startMode.value;

  resetGame(N, MODE);
})();
</script>
</body>
</html>
