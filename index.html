<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>é¹¿é¹¿ Ã— é¹¿ç²‰ï½œæ²³å…§å¡”æ¬é‹ä»»å‹™</title>

  <!-- LIFF SDKï¼ˆæ”¯æ´ï¼šåªéœ€æ”¹ä¸€è¡Œ LIFF_IDï¼‰ -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg1:#fff1f7;
      --bg2:#f3fbff;
      --card:#ffffffcc;
      --text:#12202c;
      --muted:#5b6b7a;
      --pink:#ff5fa2;
      --blue:#2b7fff;
      --gold:#ffb020;
      --shadow: 0 12px 34px rgba(0,0,0,.12);
      --radius: 18px;
      --outlineCoffee:#2b1a08;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif; color:var(--text); }
    body{
      background: radial-gradient(1200px 600px at 20% 0%, var(--bg1), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, var(--bg2), transparent 55%),
                  linear-gradient(180deg, #fff, #f8fbff);
      overflow:auto;
    }

    .wrap{
      height:auto;
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      gap:10px;
      max-width:1100px;
      margin:0 auto;
      min-height:0;
    }

    .topbar{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex: 0 0 auto;
      flex-wrap: wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 220px; }
    .logo{
      width:44px; height:44px;
      border-radius: 14px;
      background: #fff;
      border:1px solid rgba(0,0,0,.07);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      display:grid; place-items:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .title{ display:flex; flex-direction:column; gap:2px; min-width: 150px; }
    .title h1{ margin:0; font-size:15px; display:flex; align-items:center; gap:8px; white-space:nowrap; }
    .badge{
      font-size:12px;
      padding:2px 8px;
      border-radius: 999px;
      background: rgba(43,127,255,.12);
      color: var(--blue);
      border: 1px solid rgba(43,127,255,.25);
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 360px;
    }

    .right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-left:auto;
    }
    .chip{
      display:flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius: 999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip strong{ color:var(--text); font-weight:900; }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:0;
      border-radius: 999px;
      padding:10px 12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-size:13px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue), #6aa7ff);
      color:#fff;
      border:0;
    }
    .btn.danger{
      background: rgba(255,95,162,.10);
      border:1px solid rgba(255,95,162,.28);
      color: var(--pink);
    }
    .btn:active{ transform: translateY(1px); }

    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:visible;
    }
    .board{
      flex: 1 1 auto;
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px;
      position:relative;
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:hidden;
    }
    .boardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      flex: 0 0 auto;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.5;
      max-width: 70%;
    }
    .hint b{ color: var(--text); }
    .selectInfo{
      font-size:12px;
      color: var(--muted);
      text-align:right;
      white-space:nowrap;
      flex: 0 0 auto;
    }

    .poles{
      flex:1 1 auto;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      align-items:stretch;
      min-height:0;
    }

    .pole{
      position:relative;
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      border:1px dashed rgba(0,0,0,.12);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:10px 10px 14px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pole:hover{ border-color: rgba(43,127,255,.35); }
    .poleTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between;
      pointer-events:none;
      gap:10px;
    }
    .poleLabel{
      font-size:12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
      min-width: 0;
    }
    .poleLabel .dot{
      width:8px;height:8px;border-radius:99px;background:rgba(255,95,162,.45);
      flex: 0 0 auto;
    }
    .poleLabel span.name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      font-weight:800;
      color: var(--text);
    }
    .poleCount{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .rod{
      position:absolute;
      left:50%;
      bottom:64px;
      width:10px;
      height: calc(100% - 100px);
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(18,32,44,.22), rgba(18,32,44,.06));
      border-radius: 999px;
      pointer-events:none;
    }

    .platform{
      position:absolute;
      left:10px; right:10px; bottom:14px;
      height:16px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(18,32,44,.16), rgba(18,32,44,.06));
      pointer-events:none;
    }
    .pedestal{
      position:absolute;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      width: min(140px, 88%);
      height: 42px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,176,32,.85), rgba(180,120,0,.85));
      border: 2px solid rgba(0,0,0,.28);
      box-shadow: 0 10px 18px rgba(0,0,0,.12);
      display:grid;
      place-items:center;
      pointer-events:none;
    }
    .pedestal span{
      font-weight:1000;
      font-size:30px;
      line-height:1;
      color: rgba(0,0,0,.80);
      text-shadow: 0 2px 0 rgba(255,255,255,.35);
      letter-spacing: 1px;
    }

    /* âœ… ç›¤å­ï¼šå¤§åœ¨ä¸‹ã€å°åœ¨ä¸Šï¼ˆè¦–è¦ºæ­£ç¢ºï¼‰ */
    .stack{
      position:relative;
      display:flex;
      flex-direction: column-reverse;
      gap:8px;
      padding-bottom:60px;
      min-height:0;
    }

    .disk{
      height: 30px;
      border-radius: 999px;
      border:3px solid var(--outlineCoffee);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
      font-weight:1000;
      color:#fff;
      text-shadow:
        0 1px 0 rgba(0,0,0,.25),
        0 0 6px rgba(255,255,255,.25);
      font-variant-numeric: tabular-nums;
      isolation: isolate;
    }
    .disk.small{ height:28px; }

    /* âœ… æ–‘é»å±¤ï¼ˆæ¯æ—¥å›ºå®šï¼Œç”± JS å¯«å…¥ --spotsï¼‰ï¼Œé¿é–‹æ•¸å­—å€åŸŸ */
    .disk::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius:999px;
      pointer-events:none;
      z-index:0;
      background: var(--spots, none);
      mix-blend-mode: multiply;
      opacity: 0;
    }
    .disk[data-size="3"]::before{ opacity: .24; } /* 3 ç›¤å°±æ˜¯æœ€å¤§ç›¤ï¼Œçµ¦æ›´æ˜é¡¯ä¸€é» */
    .disk::after{
      content:"";
      position:absolute;
      inset:-30px -30px auto auto;
      width:90px; height:90px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 60%);
      transform: rotate(20deg);
      opacity:.7;
      pointer-events:none;
      z-index:2;
    }

    /* âœ… æ‹¿èµ·ï¼šæŠ–æŠ–ï¼ˆé¹¿é¹¿ç·Šå¼µï¼‰ */
    @keyframes luluJitter{
      0%   { transform: translateY(-3px) rotate(0deg) scale(1); }
      20%  { transform: translateY(-3px) rotate(-1.2deg) scale(1.02); }
      40%  { transform: translateY(-3px) rotate(1.2deg)  scale(1.02); }
      60%  { transform: translateY(-3px) rotate(-0.8deg) scale(1.015); }
      80%  { transform: translateY(-3px) rotate(0.8deg)  scale(1.015); }
      100% { transform: translateY(-3px) rotate(0deg) scale(1); }
    }
    .disk.selected{
      outline: 3px solid rgba(43,127,255,.65);
      transform: translateY(-3px);
      box-shadow: 0 14px 26px rgba(43,127,255,.18);
      animation: luluJitter .24s ease-in-out infinite;
      transform-origin: 50% 90%;
    }

    /* âœ… é€šé—œï¼šæœ€åº•ç›¤é‡‘å…‰é–ƒä¸€ä¸‹ */
    @keyframes luluGoldFlash{
      0%   { filter: brightness(1) saturate(1); box-shadow: 0 10px 18px rgba(0,0,0,.10); }
      35%  { filter: brightness(1.28) saturate(1.35); box-shadow: 0 0 28px rgba(255,176,32,.60); }
      70%  { filter: brightness(1.15) saturate(1.15); box-shadow: 0 0 16px rgba(255,176,32,.35); }
      100% { filter: brightness(1) saturate(1); box-shadow: 0 10px 18px rgba(0,0,0,.10); }
    }
    .disk.winFlash{ animation: luluGoldFlash .55s ease-out 1; }

    .side{
      width: 100%;
      flex: 0 0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:visible;
      padding-right: 0;
    }
    .card{
      background:var(--card);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:10px;
      flex: 0 0 auto;
    }
    .card h2{
      margin:0 0 8px;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:3px 8px;
      border-radius: 999px;
      background: rgba(255,176,32,.14);
      border:1px solid rgba(255,176,32,.28);
      color: #9a5a00;
      white-space:nowrap;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid rgba(0,0,0,.06);
      font-size:13px;
      color: var(--muted);
    }
    .row:last-child{ border-bottom:0; }
    .row b{ color: var(--text); }

    .select{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    select{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      font-size:13px;
    }

    .leader{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height: 220px;
      overflow:auto;
      padding-right: 4px;
    }
    .entry{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 10px;
      border-radius: 14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      font-size:12px;
      color: var(--muted);
    }
    .entry .name{
      max-width: 160px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--text);
      font-weight:800;
    }
    .entry .meta{
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }

    .toast{
      position: fixed;
      left:50%;
      bottom: calc(12px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(18,32,44,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 200;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-4px);
    }

    /* overlaysï¼šç¸®å°ä¸é®å¤ªå¤š */
    .overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:10px;
      background: rgba(18,32,44,.18);
      backdrop-filter: blur(6px);
      border-radius: var(--radius);
      z-index: 100;
    }
    .overlay.show{ display:flex; }

    .modal{
      width:min(560px, 96%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      padding:12px;
      border:1px solid rgba(0,0,0,.08);
      max-height: 52vh;
      overflow:auto;
    }
    .modal h3{ margin:0 0 6px; font-size:16px; display:flex; gap:8px; align-items:center; }
    .modal p{
      margin:0 0 10px;
      color: var(--muted);
      font-size:13px;
      line-height:1.55;
      white-space:pre-line;
    }
    .modal .actions{
      display:flex;
      gap:8px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .modal .actions .left{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .modal .actions .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto; }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin:10px 0 10px;
    }
    .kpi .box{
      background: rgba(43,127,255,.08);
      border:1px solid rgba(43,127,255,.18);
      border-radius: 16px;
      padding:10px;
      text-align:center;
    }
    .kpi .box .v{
      font-size:16px;
      font-weight:900;
      color: var(--text);
      font-variant-numeric: tabular-nums;
    }
    .kpi .box .t{ font-size:12px; color: var(--muted); margin-top:2px; }

    /* âœ… Winï¼šé¹¿é¹¿é»é ­ */
    .luluNod{ display:flex; justify-content:center; margin: 6px 0 2px; }
    @keyframes nod{
      0%   { transform: translateY(0) rotate(0deg); }
      18%  { transform: translateY(1px) rotate(4deg); }
      36%  { transform: translateY(0) rotate(0deg); }
      54%  { transform: translateY(1px) rotate(4deg); }
      72%  { transform: translateY(0) rotate(0deg); }
      100% { transform: translateY(0) rotate(0deg); }
    }
    .luluNod.play{ animation: nod .9s ease-in-out 1; transform-origin: 50% 60%; }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-label="é¹¿é¹¿">
          <svg width="44" height="44" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" role="img">
            <rect x="0" y="0" width="64" height="64" rx="16" fill="#FFF7FB"/>
            <path d="M22 44c0-10 8-18 18-18s18 8 18 18" stroke="#1A2B3A" stroke-width="3" stroke-linecap="round"/>
            <path d="M36 18c2-6 8-8 13-5" stroke="#FFB020" stroke-width="4" stroke-linecap="round"/>
            <path d="M33 18c-2-6-8-8-13-5" stroke="#FFB020" stroke-width="4" stroke-linecap="round"/>
            <circle cx="26" cy="34" r="3" fill="#1A2B3A"/>
            <circle cx="46" cy="34" r="3" fill="#1A2B3A"/>
            <path d="M30 42c4 3 10 3 14 0" stroke="#1A2B3A" stroke-width="3" stroke-linecap="round"/>
            <path d="M29 26c0-6 6-10 11-10" stroke="#FF5FA2" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="title">
          <h1>é¹¿é¹¿æ¬é‹ä»»å‹™ <span class="badge" id="modeBadge">LIFF</span></h1>
          <div class="sub" id="userLine">è¼‰å…¥ä¸­â€¦</div>
        </div>
      </div>

      <div class="right">
        <div class="chip">æ­¥æ•¸ <strong id="moves">0</strong></div>
        <div class="chip">æ™‚é–“ <strong id="time">00:00</strong></div>
        <div class="controls">
          <button class="btn" id="btnHow">ç©æ³•</button>
          <button class="btn" id="btnBgm">BGMï¼šé–‹</button>
          <button class="btn danger" id="btnRestart">é‡ä¾†</button>
          <button class="btn primary" id="btnClose">é—œé–‰</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="board">
        <div class="boardHeader">
          <div class="hint">
            æ“ä½œï¼š<b>é»ä¸€ä¸‹æœ€ä¸Šå±¤ç’°æ‹¿èµ· â†’ å†é»ç›®æ¨™æŸ±æ”¾ä¸‹</b>ã€‚æŠŠæ‰€æœ‰ç’°æ¬åˆ° <b>C</b> å°±é€šé—œï¼
          </div>
          <div class="selectInfo" id="selectInfo">æœªé¸å–</div>
        </div>

        <div class="poles" id="poles"></div>

        <!-- é–‹å±€ç©æ³•è¦–çª—ï¼ˆæ¯æ—¥å¿«é€Ÿé–‹å§‹ï¼‰ -->
        <div class="overlay" id="overlayStart">
          <div class="modal">
            <h3 id="startTitle">ğŸ“– ç©æ³•</h3>
            <p id="startText">é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼</p>
            <div class="actions">
              <div class="left">
                <button class="btn" id="btnStartMore">å†çœ‹ä¸€æ¬¡ç©æ³•</button>
              </div>
              <div class="right">
                <button class="btn primary" id="btnQuickStart">å¿«é€Ÿé–‹å§‹</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Win -->
        <div class="overlay" id="overlayWin">
          <div class="modal">
            <h3>ğŸ‰ ä»»å‹™å®Œæˆï¼é¹¿é¹¿é»é ­ä¸­</h3>

            <div class="luluNod" id="luluNod" aria-label="é¹¿é¹¿é»é ­">
              <svg width="86" height="86" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" role="img">
                <circle cx="32" cy="34" r="18" fill="#FFE100" stroke="#2b1a08" stroke-width="3"/>
                <path d="M22 21c-2-6-8-8-13-5" stroke="#7A3F12" stroke-width="5" stroke-linecap="round"/>
                <path d="M42 21c2-6 8-8 13-5" stroke="#7A3F12" stroke-width="5" stroke-linecap="round"/>
                <circle cx="14" cy="16" r="5" fill="#7A3F12" stroke="#2b1a08" stroke-width="3"/>
                <circle cx="50" cy="16" r="5" fill="#7A3F12" stroke="#2b1a08" stroke-width="3"/>
                <circle cx="26" cy="33" r="3.2" fill="#2b1a08"/>
                <circle cx="38" cy="33" r="3.2" fill="#2b1a08"/>
                <circle cx="20" cy="39" r="3.8" fill="#FF6A6A" opacity=".85" stroke="#2b1a08" stroke-width="2"/>
                <circle cx="44" cy="39" r="3.8" fill="#FF6A6A" opacity=".85" stroke="#2b1a08" stroke-width="2"/>
                <path d="M26 44c4 3 8 3 12 0" stroke="#2b1a08" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </div>

            <p id="winText">ä½ å®Œæˆäº†æ¬é‹ã€‚</p>

            <div class="kpi">
              <div class="box">
                <div class="v" id="kpiMoves">0</div>
                <div class="t">æ­¥æ•¸</div>
              </div>
              <div class="box">
                <div class="v" id="kpiTime">00:00</div>
                <div class="t">æ™‚é–“</div>
              </div>
              <div class="box">
                <div class="v" id="kpiBest">â€”</div>
                <div class="t">ä»Šæ—¥æœ€ä½³</div>
              </div>
            </div>
            <div class="actions">
              <div class="left">
                <button class="btn" id="btnShare">åˆ†äº«</button>
              </div>
              <div class="right">
                <button class="btn" id="btnAgain">å†ç©ä¸€æ¬¡</button>
                <button class="btn primary" id="btnNext">ä¸‹ä¸€é—œ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <h2>é—œå¡ <span class="pill">3 ç›¤ç²¾ç°¡ç‰ˆ</span></h2>

          <div class="row">
            <span>ç›¤å­æ•¸</span>
            <span><b id="levelFixed">3</b></span>
          </div>

          <div class="row">
            <span>é–‹å±€</span>
            <span class="select">
              <select id="startMode">
                <option value="standard" selected>æ¨™æº–ï¼ˆå…¨åœ¨ Aï¼‰</option>
                <option value="demo">ç¤ºç¯„ï¼ˆA:3ï¼ŒB:1ï¼ŒC:2ï¼‰</option>
              </select>
              <button class="btn" id="btnNew">é–‹å§‹</button>
            </span>
          </div>

          <div class="row">
            <span>æœ€å°‘æ­¥æ•¸</span>
            <span><b id="minMoves">â€”</b></span>
          </div>
        </div>

        <div class="card">
          <h2>ä»Šæ—¥æ’è¡Œæ¦œ <span class="pill" id="todayPill">ä»Šå¤©</span></h2>
          <div class="row">
            <span>åƒ…ä¿ç•™ä»Šæ—¥ç´€éŒ„</span>
            <span><b id="todayKey">â€”</b></span>
          </div>
          <div class="leader" id="leader"></div>
        </div>

        <div class="card">
          <h2>å°æé†’</h2>
          <div class="row"><span>ç›®æ¨™</span><span><b>å…¨éƒ¨æ¬åˆ° C</b></span></div>
          <div class="row"><span>æŸ±å­</span><span><b>A / B / C</b></span></div>
          <div class="row"><span>BGM</span><span><b>ç¨‹å¼ç”Ÿæˆï¼ˆå…éŸ³æª”ï¼‰</b></span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ========= LIFFï¼šåªæ”¹é€™ä¸€è¡Œ ========= */
const LIFF_ID = "2008838401-Ss5SClrX";
/* ====================================== */

const LS_TUTORIAL_LAST_DATE = "rr_tutorial_last_date";
const LS_DAILY_LEADER_PREFIX = "lulu_hanoi_leader_"; // + YYYY-MM-DD
const LS_DAILY_SPOTS_PREFIX  = "lulu_hanoi_spots_";  // + YYYY-MM-DD

const POLE_LABELS = ["A","B","C"];

const ui = {
  modeBadge: document.getElementById("modeBadge"),
  userLine: document.getElementById("userLine"),

  moves: document.getElementById("moves"),
  time: document.getElementById("time"),
  selectInfo: document.getElementById("selectInfo"),

  startMode: document.getElementById("startMode"),
  minMoves: document.getElementById("minMoves"),

  poles: document.getElementById("poles"),

  overlayStart: document.getElementById("overlayStart"),
  startTitle: document.getElementById("startTitle"),
  startText: document.getElementById("startText"),
  btnQuickStart: document.getElementById("btnQuickStart"),
  btnStartMore: document.getElementById("btnStartMore"),

  overlayWin: document.getElementById("overlayWin"),
  winText: document.getElementById("winText"),
  kpiMoves: document.getElementById("kpiMoves"),
  kpiTime: document.getElementById("kpiTime"),
  kpiBest: document.getElementById("kpiBest"),

  btnHow: document.getElementById("btnHow"),
  btnBgm: document.getElementById("btnBgm"),
  btnRestart: document.getElementById("btnRestart"),
  btnClose: document.getElementById("btnClose"),
  btnNew: document.getElementById("btnNew"),
  btnShare: document.getElementById("btnShare"),
  btnNext: document.getElementById("btnNext"),
  btnAgain: document.getElementById("btnAgain"),

  toast: document.getElementById("toast"),
  leader: document.getElementById("leader"),
  todayPill: document.getElementById("todayPill"),
  todayKey: document.getElementById("todayKey"),
};

let N = 3;                      // âœ… å›ºå®š 3 ç›¤
let MODE = ui.startMode.value;  // standard | demo
let stacks = [[],[],[]];
let selected = null;
let moves = 0;
let timer = null;
let startAt = null;
let elapsedSec = 0;

let readyToPlay = false;
let displayName = "é¹¿ç²‰";

/* ===== helpers ===== */
function todayStr(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function fmtTime(sec){
  sec = Math.max(0, sec|0);
  const mm = String(Math.floor(sec/60)).padStart(2,"0");
  const ss = String(sec%60).padStart(2,"0");
  return `${mm}:${ss}`;
}
function toast(msg){
  ui.toast.textContent = msg;
  ui.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1100);
}
function minMovesFor(n){ return (2 ** n) - 1; }
function displayDiskNumber(size){ return size; } // âœ… æ•¸å­—è¶Šå¤§ç›¤è¶Šå¤§ï¼ˆæ­£ç¢ºç›´è¦ºï¼‰

/* ===== âœ… Daily spots (same day fixed) ===== */
let dailySpotsCache = null;

function mulberry32(seed){
  return function(){
    let t = seed += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function hashStrToSeed(s){
  let h = 2166136261 >>> 0;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

/* âœ… 3ç›¤ç‰ˆï¼šæœ€å¤§ç›¤å°±æ˜¯ 3 â†’ ç›´æ¥å¥—ã€Œä¸»æ–‘ã€é¢¨æ ¼ï¼Œä¸¦é¿é–‹ä¸­å¤®æ•¸å­— */
function generateSpotsForSize(day, size){
  const seed = hashStrToSeed(`${day}|size:${size}|lulu3`);
  const rnd = mulberry32(seed);

  const isMax = (size === 3);
  const count = isMax ? 12 : 0;      // åªè®“æœ€å¤§ç›¤æœ‰æ–‘é»ï¼ˆæ›´åƒèº«é«”ä¸»æ–‘ï¼‰
  const baseR = 13;                 // æ–‘é»åå¤§
  const avoidRx = 18, avoidRy = 22; // ä¸­å¤®é¿è®“ï¼ˆé¿å…è“‹æ•¸å­—ï¼‰
  const marginX = 10, marginY = 16;

  const layers = [];
  let attempts = 0;

  while(layers.length < count && attempts < 140){
    attempts++;

    const x = Math.round(marginX + rnd() * (100 - marginX*2));
    const y = Math.round(marginY + rnd() * (100 - marginY*2));

    const dx = x - 50, dy = y - 50;
    const inAvoid = (dx*dx)/(avoidRx*avoidRx) + (dy*dy)/(avoidRy*avoidRy) < 1;
    if(inAvoid) continue;

    const r = Math.round(baseR * (0.8 + rnd()*0.9)); // å¤§é¡†
    const alpha = 0.40 + rnd()*0.10;
    const c = (layers.length % 2 === 0)
      ? `rgba(74,34,6,${alpha.toFixed(3)})`
      : `rgba(122,63,18,${(alpha*0.95).toFixed(3)})`;

    layers.push(`radial-gradient(circle at ${x}% ${y}%, ${c} 0 ${r}px, transparent ${r+1}px)`);
  }

  // ä¸»æ–‘å…©é¡†ï¼ˆæ›´åƒé¹¿é¹¿èº«é«”ï¼‰
  layers.push(
    `radial-gradient(circle at 24% 64%, rgba(74,34,6,0.46) 0 18px, transparent 19px)`,
    `radial-gradient(circle at 76% 58%, rgba(122,63,18,0.44) 0 17px, transparent 18px)`
  );

  return layers.join(", ");
}

function loadOrCreateDailySpots(){
  const day = todayStr();
  if(dailySpotsCache && dailySpotsCache.day === day) return dailySpotsCache.map;

  const key = LS_DAILY_SPOTS_PREFIX + day;
  try{
    const raw = localStorage.getItem(key);
    if(raw){
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object"){
        dailySpotsCache = { day, map: obj };
        return obj;
      }
    }
  }catch{}

  const map = { "3": generateSpotsForSize(day, 3) };
  try{ localStorage.setItem(key, JSON.stringify(map)); }catch{}
  dailySpotsCache = { day, map };
  return map;
}
function getDailySpots(size){
  if(size !== 3) return "";
  const map = loadOrCreateDailySpots();
  return map["3"] || "";
}

/* ===== Daily tutorial gating ===== */
function getTutorialLastDate(){
  try{ return localStorage.getItem(LS_TUTORIAL_LAST_DATE) || ""; }catch{ return ""; }
}
function setTutorialLastDate(d){
  try{ localStorage.setItem(LS_TUTORIAL_LAST_DATE, d); }catch{}
}
function showStartOverlay(){
  ui.overlayWin.classList.remove("show");
  ui.overlayStart.classList.add("show");

  const today = todayStr();
  const seenToday = (getTutorialLastDate() === today);

  if(!seenToday){
    ui.startTitle.textContent = "ğŸ“– ç©æ³•";
    ui.startText.textContent = "é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼";
    ui.btnStartMore.style.display = "inline-block";
  }else{
    ui.startTitle.textContent = "ğŸ¦’ ä»Šå¤©ç¹¼çºŒæ¬é‹";
    ui.startText.textContent = "æŒ‰å³ä¸‹è§’ã€Œå¿«é€Ÿé–‹å§‹ã€ç«‹åˆ»é–‹ç©ã€‚";
    ui.btnStartMore.style.display = "inline-block";
  }
}
function hideStartOverlay(){ ui.overlayStart.classList.remove("show"); }

/* ===== Daily leaderboard ===== */
function leaderKey(){ return LS_DAILY_LEADER_PREFIX + todayStr(); }
function loadLeaders(){
  const key = leaderKey();
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr
      .filter(x => x && typeof x === "object")
      .map(x => ({
        name: String(x.name || "é¹¿ç²‰").slice(0, 24),
        moves: Number(x.moves),
        timeSec: Number(x.timeSec),
        level: Number(x.level),
        mode: String(x.mode || "standard"),
        ts: Number(x.ts || 0),
      }))
      .filter(x => isFinite(x.moves) && isFinite(x.timeSec) && isFinite(x.level));
  }catch{ return []; }
}
function saveLeaders(arr){
  try{ localStorage.setItem(leaderKey(), JSON.stringify(arr)); }catch{}
}
function addLeaderEntry(entry){
  const arr = loadLeaders();
  arr.push(entry);
  arr.sort((a,b)=>{
    if(a.moves !== b.moves) return a.moves - b.moves;
    if(a.timeSec !== b.timeSec) return a.timeSec - b.timeSec;
    return (a.ts||0) - (b.ts||0);
  });
  saveLeaders(arr.slice(0,10));
  renderLeaders();
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function renderLeaders(){
  const list = loadLeaders();
  ui.leader.innerHTML = "";
  ui.todayKey.textContent = todayStr();

  if(list.length === 0){
    const e = document.createElement("div");
    e.className = "entry";
    e.innerHTML = `<span class="name">ä»Šå¤©é‚„æ²’äººé€šé—œ</span><span class="meta">å…ˆç•¶ç¬¬ä¸€åï¼</span>`;
    ui.leader.appendChild(e);
    ui.kpiBest.textContent = "â€”";
    return;
  }

  list.forEach((x, idx)=>{
    const e = document.createElement("div");
    e.className = "entry";
    const rank = idx===0 ? "ğŸ¥‡" : idx===1 ? "ğŸ¥ˆ" : idx===2 ? "ğŸ¥‰" : `#${idx+1}`;
    const modeTag = (x.mode === "demo") ? "ç¤ºç¯„" : "æ¨™æº–";
    e.innerHTML = `
      <span class="name">${rank} ${escapeHtml(x.name)}</span>
      <span class="meta">${x.moves}æ­¥ Â· ${fmtTime(x.timeSec)} Â· ${x.level}ç›¤ Â· ${modeTag}</span>
    `;
    ui.leader.appendChild(e);
  });

  const best = list[0];
  ui.kpiBest.textContent = `${best.moves} / ${fmtTime(best.timeSec)}`;
}

/* ===== Game ===== */
function startTimer(){
  stopTimer();
  startAt = Date.now() - elapsedSec*1000;
  timer = setInterval(()=>{
    elapsedSec = Math.floor((Date.now() - startAt)/1000);
    ui.time.textContent = fmtTime(elapsedSec);
  }, 250);
}
function stopTimer(){
  if(timer){ clearInterval(timer); timer=null; }
}

function resetGame(mode){
  MODE = mode;
  stacks = [[],[],[]];
  selected = null;
  moves = 0;
  elapsedSec = 0;

  ui.moves.textContent = "0";
  ui.time.textContent = "00:00";
  ui.selectInfo.textContent = "æœªé¸å–";
  ui.overlayWin.classList.remove("show");

  ui.minMoves.textContent = String(minMovesFor(N));

  if(MODE === "demo"){
    stacks[0].push(3);
    stacks[1].push(1);
    stacks[2].push(2);
  }else{
    stacks[0].push(3,2,1);
  }

  render();
  renderLeaders();

  readyToPlay = false;
  stopTimer();
  showStartOverlay();
}

function diskWidthPercent(size){
  const min = 42, max = 94;
  const t = (size-1)/(N-1 || 1);
  return min + (max-min)*t;
}
function diskColor(size){
  const colors = {
    1: ["#FFF36A", "#FFE033"],
    2: ["#FFE100", "#FFC400"],
    3: ["#7A3F12", "#4A2206"], // âœ… æœ€å¤§ç›¤ï¼šå’–å•¡åº•
  };
  const [c1, c2] = colors[size] || colors[3];
  return `linear-gradient(180deg, ${c1}, ${c2})`;
}

function topDisk(poleIndex){
  const arr = stacks[poleIndex];
  return arr.length ? arr[arr.length-1] : null;
}
function canPlace(size, poleIndex){
  const top = topDisk(poleIndex);
  if(top === null) return true;
  return size < top;
}

function render(){
  ui.poles.innerHTML = "";

  for(let i=0;i<3;i++){
    const pole = document.createElement("div");
    pole.className = "pole";

    const poleTop = document.createElement("div");
    poleTop.className = "poleTop";
    poleTop.innerHTML = `
      <div class="poleLabel">
        <span class="dot"></span>
        <span class="name">${POLE_LABELS[i]}</span>
      </div>
      <div class="poleCount">${stacks[i].length} æš</div>
    `;

    const rod = document.createElement("div"); rod.className = "rod";
    const platform = document.createElement("div"); platform.className = "platform";
    const pedestal = document.createElement("div"); pedestal.className = "pedestal";
    pedestal.innerHTML = `<span>${POLE_LABELS[i]}</span>`;

    const stack = document.createElement("div"); stack.className = "stack";

    for(const size of stacks[i]){
      const d = document.createElement("div");
      d.className = "disk" + (size<=2 ? " small": "");
      d.style.width = diskWidthPercent(size) + "%";
      d.style.background = diskColor(size);
      d.textContent = String(displayDiskNumber(size));
      d.dataset.pole = String(i);
      d.dataset.size = String(size);

      // âœ… æœ€å¤§ç›¤(3)æ¯æ—¥å›ºå®šæ–‘é»ï¼Œä¸¦é¿é–‹ä¸­å¤®æ•¸å­—
      const spots = getDailySpots(size);
      if(spots) d.style.setProperty("--spots", spots);
      else d.style.removeProperty("--spots");

      const isTop = (size === stacks[i][stacks[i].length-1]);
      const isSelected = selected && selected.fromPole === i && selected.size === size && isTop;
      if(isSelected) d.classList.add("selected");

      d.addEventListener("click",(e)=>{ e.stopPropagation(); onPoleTap(i); });
      stack.appendChild(d);
    }

    pole.appendChild(poleTop);
    pole.appendChild(rod);
    pole.appendChild(platform);
    pole.appendChild(pedestal);
    pole.appendChild(stack);

    pole.addEventListener("click", ()=> onPoleTap(i));
    ui.poles.appendChild(pole);
  }
}

function onPoleTap(poleIndex){
  if(ui.overlayStart.classList.contains("show")) return;
  if(!readyToPlay) return;

  if(!selected){
    const size = topDisk(poleIndex);
    if(size === null){ toast("é€™æ ¹æŸ±å­ç©ºç©ºçš„ï½"); return; }
    selected = { fromPole: poleIndex, size };
    ui.selectInfo.textContent = `å·²æ‹¿èµ·ï¼š${displayDiskNumber(size)}ï¼ˆ${POLE_LABELS[poleIndex]}ï¼‰`;
    sfxPop("pick");
    render();
    return;
  }

  const { fromPole, size } = selected;
  if(poleIndex === fromPole){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  if(!canPlace(size, poleIndex)){
    toast("æ”¾ä¸ä¸‹ï¼šå…ˆæŠŠå°çš„æ”¾ä¸Šé¢ï½");
    sfxPop("bad");
    return;
  }

  const fromArr = stacks[fromPole];
  const actual = fromArr[fromArr.length-1];
  if(actual !== size){
    selected = null;
    ui.selectInfo.textContent = "æœªé¸å–";
    render();
    return;
  }

  fromArr.pop();
  stacks[poleIndex].push(size);

  moves += 1;
  ui.moves.textContent = String(moves);
  selected = null;
  ui.selectInfo.textContent = "æœªé¸å–";
  sfxPop("drop");
  render();

  checkWin();
}

function checkWin(){
  if(stacks[2].length !== N) return;

  stopTimer();

  // âœ… é€šé—œï¼šæœ€åº•ç›¤ï¼ˆ3ï¼‰é‡‘å…‰é–ƒä¸€ä¸‹
  requestAnimationFrame(()=>{
    const el = document.querySelector(`.disk[data-pole="2"][data-size="3"]`);
    if(el){
      el.classList.remove("winFlash");
      void el.offsetWidth;
      el.classList.add("winFlash");
    }
  });

  ui.overlayWin.classList.add("show");

  // âœ… é¹¿é¹¿é»é ­
  const nod = document.getElementById("luluNod");
  if(nod){
    nod.classList.remove("play");
    void nod.offsetWidth;
    nod.classList.add("play");
  }

  const theoretical = minMovesFor(N);
  const rank = moves === theoretical ? "å®Œç¾é¹¿ç²‰ï¼" : (moves <= theoretical + 2 ? "ç¥ç´šé¹¿ç²‰ï¼" : "åˆæ ¼é¹¿ç²‰ï¼");
  ui.winText.textContent =
    `ä½ ç”¨ ${moves} æ­¥ã€${fmtTime(elapsedSec)} å®Œæˆã€Œ${N} ç›¤æ¬é‹ã€âœ¨\n${rank}ï¼ˆæœ€å°‘ï¼š${theoretical} æ­¥ï¼‰`;

  ui.kpiMoves.textContent = String(moves);
  ui.kpiTime.textContent = fmtTime(elapsedSec);

  addLeaderEntry({
    name: displayName || "é¹¿ç²‰",
    moves,
    timeSec: elapsedSec,
    level: N,
    mode: MODE,
    ts: Date.now()
  });

  renderLeaders();
}

/* ===== Procedural chill BGM + é»æ“Šæ³¡æ³¡ ===== */
let bgmOn = true;
let audio = { ctx:null, master:null, musicGain:null, noiseGain:null, lp:null, started:false, nextNoteT:0, timer:null, seed:0 };
function ensureAudio(){
  if(audio.ctx) return;
  audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
  audio.master = audio.ctx.createGain();
  audio.master.gain.value = 0.55;
  audio.master.connect(audio.ctx.destination);

  audio.lp = audio.ctx.createBiquadFilter();
  audio.lp.type = "lowpass";
  audio.lp.frequency.value = 1600;
  audio.lp.Q.value = 0.6;

  audio.musicGain = audio.ctx.createGain();
  audio.musicGain.gain.value = 0.85;

  audio.noiseGain = audio.ctx.createGain();
  audio.noiseGain.gain.value = 0.20;

  audio.musicGain.connect(audio.lp);
  audio.noiseGain.connect(audio.lp);
  audio.lp.connect(audio.master);
}
function setBgmButton(){ ui.btnBgm.textContent = `BGMï¼š${bgmOn ? "é–‹" : "é—œ"}`; }
function startBgmIfNeeded(){
  if(!bgmOn) return;
  ensureAudio();
  if(audio.ctx.state === "suspended") audio.ctx.resume().catch(()=>{});
  if(audio.started) return;
  audio.started = true;
  audio.seed = (Date.now() % 9973) | 0;
  audio.nextNoteT = audio.ctx.currentTime + 0.06;
  audio.timer = setInterval(scheduler, 100);
}
function stopBgm(){
  if(audio.timer){ clearInterval(audio.timer); audio.timer=null; }
  audio.started = false;
}
function scheduler(){
  if(!audio.ctx) return;
  const lookAhead = 0.35;
  while(audio.nextNoteT < audio.ctx.currentTime + lookAhead){
    scheduleStep(audio.nextNoteT);
    audio.nextNoteT += stepDur();
  }
}
function bpm(){ return 82; }           // 3ç›¤ç‰ˆç¨å¾®æ›´è¼•å¿«
function stepDur(){ return 60 / bpm(); }
function rand(){
  audio.seed = (audio.seed * 1103515245 + 12345) & 0x7fffffff;
  return (audio.seed / 0x7fffffff);
}
function noteFreq(midi){ return 440 * Math.pow(2, (midi - 69) / 12); }
const CHORDS = [
  [60, 64, 67, 71],
  [57, 60, 64, 67],
  [62, 65, 69, 72],
  [55, 59, 62, 65],
];
let stepCount = 0;

function scheduleStep(t){
  const ctx = audio.ctx;
  const bar = Math.floor(stepCount / 4) % CHORDS.length;
  const chord = CHORDS[bar];

  if(stepCount % 2 === 0){
    chord.forEach((m, i)=>{
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "triangle";
      o.detune.setValueAtTime((i - 1.5) * 3, t);
      o.frequency.setValueAtTime(noteFreq(m - 12), t);

      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.045, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.70);

      o.connect(g);
      g.connect(audio.musicGain);
      o.start(t);
      o.stop(t + 0.75);
    });
  }

  if(stepCount % 4 === 0){
    const root = chord[0] - 24;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();
    o.type = "sine";
    o.frequency.setValueAtTime(noteFreq(root), t);
    f.type = "lowpass";
    f.frequency.setValueAtTime(180, t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.085, t + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.33);

    o.connect(f); f.connect(g); g.connect(audio.musicGain);
    o.start(t); o.stop(t + 0.34);
  }

  if(stepCount % 2 === 1){
    noiseTick(t, 0.04, 2800 + rand()*700, 0.045);
  }

  if(stepCount % 4 === 0){ kick(t); }

  stepCount++;
}
function noiseBuffer(){
  const ctx = audio.ctx;
  const len = ctx.sampleRate * 0.2;
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<len;i++){
    data[i] = (Math.random()*2-1) * (0.9 - i/len);
  }
  return buf;
}
function noiseTick(t, dur, cutoff, amp){
  const ctx = audio.ctx;
  const src = ctx.createBufferSource();
  src.buffer = noiseBuffer();
  const f = ctx.createBiquadFilter();
  f.type = "highpass";
  f.frequency.setValueAtTime(cutoff, t);

  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(amp, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

  src.connect(f); f.connect(g); g.connect(audio.noiseGain);
  src.start(t);
  src.stop(t + dur + 0.02);
}
function kick(t){
  const ctx = audio.ctx;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";
  o.frequency.setValueAtTime(135, t);
  o.frequency.exponentialRampToValueAtTime(55, t + 0.085);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.14, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);

  o.connect(g); g.connect(audio.musicGain);
  o.start(t);
  o.stop(t + 0.13);
}

/* âœ… é»æ“Šå›é¥‹éŸ³æ•ˆï¼ˆæ³¡æ³¡ï¼‰ */
function sfxPop(kind){
  if(!bgmOn) return;
  ensureAudio();
  const ctx = audio.ctx;
  const t = ctx.currentTime;
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";
  const f = kind==="pick" ? 560 : (kind==="drop" ? 440 : 320);
  o.frequency.setValueAtTime(f, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.038, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.10);
  o.connect(g); g.connect(audio.master);
  o.start(t); o.stop(t + 0.11);
}

/* ===== LIFF init ===== */
async function initLIFF(){
  const inLineUA = /Line/i.test(navigator.userAgent);
  try{
    if(window.liff && LIFF_ID){
      await liff.init({ liffId: LIFF_ID });
      ui.modeBadge.textContent = liff.isInClient() ? "LINE" : "WEB";
      if(liff.isLoggedIn()){
        const p = await liff.getProfile();
        displayName = p.displayName || "é¹¿ç²‰";
        ui.userLine.textContent = `Hi ${displayName}ï½œé¹¿ç²‰è«‹å°±ä½ ğŸ¦’âœ¨`;
      }else{
        displayName = "é¹¿ç²‰";
        ui.userLine.textContent = "æœªç™»å…¥ï¼ˆä»å¯ç›´æ¥ç©ï¼‰";
      }
      return;
    }
  }catch{}
  ui.modeBadge.textContent = inLineUA ? "LINE" : "WEB";
  displayName = "é¹¿ç²‰";
  ui.userLine.textContent = inLineUA ? "åœ¨ LINE å…§é–‹å•Ÿ âœ…" : "ä¸€èˆ¬ç€è¦½å™¨æ¨¡å¼";
}

function closeWindow(){
  if(window.liff && liff.isInClient && liff.isInClient()) liff.closeWindow();
  else toast("é LINE å…§ï¼Œç„¡æ³•è‡ªå‹•é—œé–‰");
}
async function shareResult(){
  const modeTag = (MODE === "demo") ? "ç¤ºç¯„" : "æ¨™æº–";
  const text = `ğŸ¦’âœ¨ ${displayName} å®Œæˆã€Œé¹¿é¹¿æ¬é‹ä»»å‹™ã€ï¼š${N}ç›¤ï¼${moves}æ­¥ï¼${fmtTime(elapsedSec)}ï¼ˆ${modeTag}ï¼‰ï¼`;
  try{
    if(window.liff && liff.isApiAvailable && liff.isApiAvailable("shareTargetPicker")){
      await liff.shareTargetPicker([{ type:"text", text }]);
      toast("å·²å‘¼å«åˆ†äº«");
    }else{
      await navigator.clipboard.writeText(text);
      toast("å·²è¤‡è£½åˆ†äº«æ–‡å­—");
    }
  }catch{
    try{ prompt("è¤‡è£½åˆ†äº«æ–‡å­—ï¼š", text); }catch{}
  }
}
function showHowModal(){
  ui.startTitle.textContent = "ğŸ“– ç©æ³•";
  ui.startText.textContent = "é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼";
  ui.btnStartMore.style.display = "none";
  ui.overlayStart.classList.add("show");
}

/* ===== events ===== */
ui.btnHow.addEventListener("click", ()=> showHowModal());
ui.btnBgm.addEventListener("click", ()=>{
  bgmOn = !bgmOn;
  setBgmButton();
  if(!bgmOn) stopBgm();
  else startBgmIfNeeded();
});
ui.btnRestart.addEventListener("click", ()=> resetGame(MODE));
ui.btnClose.addEventListener("click", closeWindow);

ui.btnNew.addEventListener("click", ()=>{
  const mode = ui.startMode.value;
  resetGame(mode);
});

ui.btnQuickStart.addEventListener("click", ()=>{
  setTutorialLastDate(todayStr());
  hideStartOverlay();
  readyToPlay = true;
  startTimer();
  startBgmIfNeeded();
  toast("é¹¿ç²‰é›†åˆï¼é–‹æ¬ï½");
});
ui.btnStartMore.addEventListener("click", ()=>{
  ui.startTitle.textContent = "ğŸ“– ç©æ³•";
  ui.startText.textContent = "é»ä¸€ä¸‹æœ€ä¸Šå±¤ã€Œç’°ã€æ‹¿èµ·ï¼Œå†é»ç›®æ¨™æŸ±å­æ”¾ä¸‹ã€‚\næŠŠå…¨éƒ¨ç’°æ¬åˆ° Cï¼Œå°±å®Œæˆä»»å‹™ï¼";
  ui.btnStartMore.textContent = "å†çœ‹ä¸€æ¬¡ç©æ³•";
  ui.btnStartMore.style.display = "inline-block";
});

ui.btnShare.addEventListener("click", shareResult);
ui.btnAgain.addEventListener("click", ()=>{ ui.overlayWin.classList.remove("show"); resetGame(MODE); });
ui.btnNext.addEventListener("click", ()=>{
  // âœ… 3 ç›¤å›ºå®šï¼šä¸‹ä¸€é—œç­‰åŒå†ç©ä¸€æ¬¡
  ui.overlayWin.classList.remove("show");
  toast("3 ç›¤ç²¾ç°¡ç‰ˆï¼šå†æŒ‘æˆ°ä¸€æ¬¡ï¼");
  resetGame(MODE);
});

/* ===== boot ===== */
(function purgeOldLeaderboards(){
  const today = LS_DAILY_LEADER_PREFIX + todayStr();
  try{
    const del = [];
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(k && k.startsWith(LS_DAILY_LEADER_PREFIX) && k !== today) del.push(k);
    }
    del.forEach(k=> localStorage.removeItem(k));
  }catch{}
})();

(async function main(){
  setBgmButton();
  await initLIFF();
  ui.todayPill.textContent = "ä»Šå¤©";
  ui.todayKey.textContent = todayStr();
  loadOrCreateDailySpots();  // âœ… å…ˆç”Ÿæˆä»Šæ—¥æœ€å¤§ç›¤æ–‘é»
  renderLeaders();
  resetGame(MODE);
})();
</script>
</body>
</html>
